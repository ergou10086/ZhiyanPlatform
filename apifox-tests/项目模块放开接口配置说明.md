# 项目模块接口访问权限配置说明

## 📍 当前已放开的接口

### 1. 公开项目接口（无需登录）

| 路径模式 | 说明 | 使用场景 |
|---------|------|----------|
| `/api/projects/public/**` | 所有public开头的接口 | 项目广场、公开项目列表 |
| `/api/projects/*/public` | 单个公开项目详情 | 查看公开项目详情 |
| `/api/projects/search/public` | 公开项目搜索 | 搜索公开项目 |
| `/api/project-members/*/public` | 项目公开成员列表 | 查看项目团队成员 |

---

## 🔧 如何添加更多放开的接口

### 位置
文件：`zhiyan-common/zhiyan-common-security/src/main/java/hbnu/project/zhiyancommonsecurity/config/SecurityConfig.java`

### 方案1：放开所有GET查询接口（开发测试用）

在 `filterChain` 方法中的 `authorizeHttpRequests` 部分添加：

```java
// 项目服务所有GET接口 - 临时开发测试用（上线前需要删除）
.requestMatchers(HttpMethod.GET, "/api/projects/**").permitAll()
.requestMatchers(HttpMethod.GET, "/api/project-members/**").permitAll()
.requestMatchers(HttpMethod.GET, "/api/tasks/**").permitAll()
```

⚠️ **注意**：此方案仅用于开发测试，生产环境不建议使用！

### 方案2：按具体接口放开（推荐）

根据业务需求，精确放开特定接口：

```java
// 项目查询接口 - 无需登录
.requestMatchers(
        "/api/projects",                    // 获取所有项目（分页）
        "/api/projects/{projectId}",        // 获取项目详情
        "/api/projects/status/*",           // 按状态查询项目
        "/api/projects/search"              // 搜索项目
).permitAll()

// 任务查询接口 - 无需登录
.requestMatchers(
        "/api/tasks/{taskId}",              // 获取任务详情
        "/api/tasks/project/*"              // 获取项目任务列表
).permitAll()
```

### 方案3：完全放开项目模块（不推荐）

```java
// 完全放开项目模块所有接口 - 不建议在生产环境使用
.requestMatchers("/api/projects/**").permitAll()
.requestMatchers("/api/project-members/**").permitAll()
.requestMatchers("/api/tasks/**").permitAll()
```

---

## 📝 常用配置示例

### 示例1：放开项目列表和详情查询

```java
.requestMatchers(
        "/api/projects",                    // 获取所有项目
        "/api/projects/{projectId}",        // 获取项目详情
        "/api/projects/my-projects",        // 我参与的项目
        "/api/projects/my-created"          // 我创建的项目
).permitAll()
```

### 示例2：放开项目统计接口

```java
.requestMatchers(
        "/api/projects/count/**"            // 所有统计接口
).permitAll()
```

### 示例3：只放开公开项目相关接口（推荐）

```java
.requestMatchers(
        "/api/projects/public/**",          // 公开项目列表
        "/api/projects/*/public",           // 公开项目详情
        "/api/projects/search/public",      // 公开项目搜索
        "/api/project-members/*/public"     // 公开项目成员
).permitAll()
```

---

## 🔐 安全建议

### 1. 最小权限原则
- 只放开真正需要公开访问的接口
- 其他接口保持需要登录认证

### 2. 使用 @PreAuthorize 注解
即使接口在SecurityConfig中未限制，也可以在Controller方法上使用注解控制：

```java
@GetMapping("/{projectId}")
@PreAuthorize("isAuthenticated()")  // 需要登录
public R<Project> getProject(@PathVariable Long projectId) {
    // ...
}

@GetMapping("/public/{projectId}")
// 无需 @PreAuthorize，任何人都可以访问
public R<Project> getPublicProject(@PathVariable Long projectId) {
    // ...
}
```

### 3. 数据过滤
对于公开接口，在业务层需要过滤敏感数据：

```java
public R<Project> getPublicProject(Long projectId) {
    Project project = projectRepository.findById(projectId);
    
    // 只返回公开项目
    if (project.getVisibility() != ProjectVisibility.PUBLIC) {
        return R.fail("项目不公开");
    }
    
    // 过滤敏感字段
    project.setInternalNotes(null);
    
    return R.ok(project);
}
```

---

## 🧪 测试验证

### 放开后的测试方法

#### 1. 不带Token访问（应该成功）
```bash
curl http://localhost:8080/api/projects/public/active
```

#### 2. 访问需要认证的接口（应该返回401）
```bash
curl http://localhost:8080/api/projects/my-created
# 预期返回: 401 Unauthorized
```

#### 3. 带Token访问（应该成功）
```bash
curl -H "Authorization: Bearer {token}" \
     http://localhost:8080/api/projects/my-created
```

---

## 📊 接口访问权限对照表

| 接口 | 当前状态 | 说明 |
|------|---------|------|
| `/api/projects/public/active` | ✅ 公开 | 获取公开活跃项目 |
| `/api/projects/{id}` | 🔒 需登录 | 获取项目详情 |
| `/api/projects/my-created` | 🔒 需登录 | 我创建的项目 |
| `/api/projects` | 🔒 需登录 | 所有项目（需OWNER角色） |
| `POST /api/projects` | 🔒 需登录 | 创建项目 |
| `PUT /api/projects/{id}` | 🔒 需登录 | 更新项目 |
| `DELETE /api/projects/{id}` | 🔒 需登录 | 删除项目 |

---

## 🔄 修改后重启服务

修改 `SecurityConfig.java` 后，需要重启项目服务才能生效：

```bash
# 停止服务
# 在IDEA中点击红色停止按钮

# 重新启动
# 在IDEA中运行 ZhiyanProjectApplication
```

---

## 💡 推荐配置（生产环境）

```java
// 项目服务公开接口 - 无需登录（供项目广场等公开展示使用）
.requestMatchers(
        "/api/projects/public/**",           // 公开项目列表、项目广场等
        "/api/projects/*/public",            // 单个公开项目详情
        "/api/projects/search/public",       // 公开项目搜索
        "/api/projects/count/public"         // 公开项目统计
).permitAll()

// 项目成员公开接口 - 无需登录（查看项目成员信息）
.requestMatchers(
        "/api/project-members/*/public"      // 查看项目公开成员列表
).permitAll()
```

这种配置：
- ✅ 安全性高 - 只放开了必要的公开接口
- ✅ 可维护性好 - 清晰的接口命名规范
- ✅ 扩展性好 - 可以方便地添加新的公开接口

---

**如果需要临时放开更多接口用于测试，建议在配置中添加 TODO 注释，上线前删除。**

