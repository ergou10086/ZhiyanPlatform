# 项目级权限测试步骤

## 🎯 测试目标

验证用户在不同项目中的权限是**独立隔离**的。

---

## 📋 准备工作

### 1. 准备测试账号

建议准备2个测试账号：
- **账号A**：张三（user_a@test.com）
- **账号B**：李四（user_b@test.com）

### 2. 登录获取Token

```http
POST http://localhost:8091/zhiyan/auth/login
Content-Type: application/json

{
  "email": "user_a@test.com",
  "password": "password123",
  "rememberMe": false
}
```

保存返回的 `accessToken` 到环境变量。

---

## 🧪 测试场景

### 场景1：创建两个项目

#### 步骤1.1：张三创建"智研"项目

```http
POST http://localhost:8080/api/projects?name=智研&description=智研项目
Authorization: Bearer {{accessToken_userA}}
```

**预期**：
- ✅ 200 OK
- ✅ 项目创建成功
- 记录返回的 `projectId`，假设为 `100`
- 张三自动成为项目100的 `OWNER`

#### 步骤1.2：张三创建"梦景"项目

```http
POST http://localhost:8080/api/projects?name=梦景&description=梦景项目
Authorization: Bearer {{accessToken_userA}}
```

**预期**：
- ✅ 200 OK
- ✅ 项目创建成功
- 记录返回的 `projectId`，假设为 `200`
- 张三自动成为项目200的 `OWNER`

---

### 场景2：添加成员

#### 步骤2.1：在"梦景"项目中，将张三的角色改为MEMBER

（这需要先添加一个新的OWNER，或者直接在数据库中修改）

**临时方案**：用李四登录，创建梦景项目，然后添加张三为MEMBER

1. 李四登录，创建"梦景"项目（projectId=200）
2. 李四添加张三为项目成员

```http
POST http://localhost:8080/api/project-members/projects/200/members
Authorization: Bearer {{accessToken_userB}}
Content-Type: application/json

{
  "userId": {{userA_id}},
  "role": "MEMBER"
}
```

现在状态：
- 项目100（智研）：张三是 `OWNER`
- 项目200（梦景）：张三是 `MEMBER`，李四是 `OWNER`

---

### 场景3：测试删除权限

#### 测试3.1：张三删除"智研"项目（应该成功）

```http
DELETE http://localhost:8080/api/projects/100
Authorization: Bearer {{accessToken_userA}}
```

**预期**：
- ✅ 200 OK
- ✅ 项目删除成功
- ✅ 原因：张三在项目100中是OWNER，拥有DELETE权限

#### 测试3.2：张三删除"梦景"项目（应该失败）

```http
DELETE http://localhost:8080/api/projects/200
Authorization: Bearer {{accessToken_userA}}
```

**预期**：
- ❌ 403 Forbidden 或 500 Internal Server Error
- ❌ 错误信息：`"您在该项目中没有 删除项目 权限"`
- ❌ 原因：张三在项目200中只是MEMBER，没有DELETE权限

---

### 场景4：测试更新权限

#### 测试4.1：张三更新"智研"项目

```http
PUT http://localhost:8080/api/projects/100?name=智研平台&description=更新后的描述
Authorization: Bearer {{accessToken_userA}}
```

**预期**：
- ✅ 200 OK（如果还没删除的话）
- ✅ 更新成功

#### 测试4.2：张三更新"梦景"项目

```http
PUT http://localhost:8080/api/projects/200?name=梦景平台&description=更新后的描述
Authorization: Bearer {{accessToken_userA}}
```

**预期**：
- ❌ 403 Forbidden
- ❌ 错误信息：`"您在该项目中没有 管理项目基本信息 权限"`
- ❌ 原因：MEMBER角色没有PROJECT_MANAGE权限

---

### 场景5：测试归档权限

#### 测试5.1：张三归档"智研"项目

```http
POST http://localhost:8080/api/projects/100/archive
Authorization: Bearer {{accessToken_userA}}
```

**预期**：
- ✅ 200 OK
- ✅ 归档成功

#### 测试5.2：张三归档"梦景"项目

```http
POST http://localhost:8080/api/projects/200/archive
Authorization: Bearer {{accessToken_userA}}
```

**预期**：
- ❌ 403 Forbidden
- ❌ 错误信息：`"只有项目拥有者可以执行此操作"`
- ❌ 原因：只有OWNER可以归档项目

---

## 📊 测试结果对照表

| 操作 | 项目 | 张三角色 | 预期结果 | 实际结果 |
|------|------|---------|----------|----------|
| 删除项目 | 智研(100) | OWNER | ✅ 成功 | |
| 删除项目 | 梦景(200) | MEMBER | ❌ 失败 | |
| 更新项目 | 智研(100) | OWNER | ✅ 成功 | |
| 更新项目 | 梦景(200) | MEMBER | ❌ 失败 | |
| 归档项目 | 智研(100) | OWNER | ✅ 成功 | |
| 归档项目 | 梦景(200) | MEMBER | ❌ 失败 | |

---

## 🔍 如何验证权限

### 方法1：查看用户在项目中的角色

```http
GET http://localhost:8080/api/project-members/projects/{{projectId}}/my-role
Authorization: Bearer {{accessToken}}
```

**响应示例**：
```json
{
  "code": 200,
  "data": "OWNER"  // 或 "MEMBER"
}
```

### 方法2：检查是否为项目拥有者

```http
GET http://localhost:8080/api/project-members/projects/{{projectId}}/check-owner
Authorization: Bearer {{accessToken}}
```

**响应示例**：
```json
{
  "code": 200,
  "data": true  // 或 false
}
```

### 方法3：检查是否为项目成员

```http
GET http://localhost:8080/api/project-members/projects/{{projectId}}/check-membership
Authorization: Bearer {{accessToken}}
```

---

## 💡 快速测试脚本

### 在Apifox中创建测试流程

1. **创建测试环境变量**：
   ```
   projectId_zhiyan: 100
   projectId_mengjing: 200
   userA_token: (张三的token)
   userB_token: (李四的token)
   ```

2. **按顺序执行测试**：
   - 登录 → 创建项目 → 添加成员 → 测试权限

3. **检查响应状态码**：
   - 200 = 成功
   - 403 = 权限不足
   - 404 = 资源不存在

---

## ✅ 验证成功的标志

如果测试通过，你应该看到：

1. ✅ 张三在"智研"项目中可以执行**所有操作**
2. ❌ 张三在"梦景"项目中**不能删除、不能归档、不能更新**
3. ✅ 李四在"梦景"项目中可以执行**所有操作**

**这证明权限是项目隔离的！** 🎉

---

## 🐛 常见问题

### Q1: 所有操作都返回403？

**检查**：
1. Token是否有效？
2. 用户是否已登录？
3. 查看后端日志，确认具体错误

### Q2: MEMBER也能删除项目？

**检查**：
1. 确认后端代码已经更新
2. 确认服务已经重启
3. 查看数据库中该用户的角色

### Q3: 错误信息不明确？

**优化建议**：
在Controller中添加try-catch，返回更友好的错误信息：

```java
try {
    projectSecurityUtils.requirePermission(projectId, ProjectPermission.PROJECT_DELETE);
} catch (SecurityException e) {
    return R.fail(e.getMessage());
}
```

---

**开始测试，验证你的项目级权限系统！** 🚀

