# ä»»åŠ¡åˆ†é…/æ¥å–åŠŸèƒ½task_userè¡¨åŒæ­¥ä¿®å¤è¯´æ˜

## ğŸ“‹ é—®é¢˜æè¿°

**ç”¨æˆ·åé¦ˆ**ï¼šåˆ†é…æˆ–æ¥å–ä»»åŠ¡åï¼Œæ²¡æœ‰å°†åŒæ­¥è®°å½•åœ¨task_userè¡¨ä¸­

## ğŸ” æ ¹å› åˆ†æ

TaskServiceImplä¸­çš„ä»¥ä¸‹æ–¹æ³•**æœªæ›´æ–°åˆ°task_userè¡¨**ï¼Œä»åœ¨ä½¿ç”¨æ—§çš„JSONæ–¹å¼ï¼š

1. âŒ `createTask()` - åˆ›å»ºä»»åŠ¡æ—¶åªæ›´æ–°äº†assigneeIdå­—æ®µ
2. âŒ `assignTask()` - åˆ†é…ä»»åŠ¡æ—¶åªæ›´æ–°äº†assigneeIdå­—æ®µ
3. âŒ `claimTask()` - æ¥å–ä»»åŠ¡æ—¶åªæ›´æ–°äº†assigneeIdå­—æ®µ

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. æ·»åŠ ä¾èµ–æ³¨å…¥

**æ–‡ä»¶**: `TaskServiceImpl.java`

```java
// âœ… æ–°å¢ï¼štask_userå…³è”è¡¨Repository
private final TaskUserRepository taskUserRepository;
```

### 2. æ·»åŠ å¿…è¦çš„import

```java
import hbnu.project.zhiyanproject.model.entity.TaskUser;
import hbnu.project.zhiyanproject.model.enums.AssignType;
import hbnu.project.zhiyanproject.model.enums.RoleType;
import hbnu.project.zhiyanproject.repository.TaskUserRepository;
import java.time.Instant;
```

---

## ğŸ”§ æ ¸å¿ƒæ–¹æ³•ä¿®å¤è¯¦æƒ…

### æ–¹æ³•1ï¼šcreateTask() - åˆ›å»ºä»»åŠ¡æ—¶åŒæ­¥å†™å…¥task_user

**ä¿®å¤å‰**ï¼š
```java
// åªæ›´æ–°JSONå­—æ®µ
task.setAssigneeId(assigneeIdsJson);
```

**ä¿®å¤å**ï¼š
```java
// 1. assigneeIdè®¾ä¸ºç©ºï¼ˆåºŸå¼ƒå­—æ®µï¼‰
task.setAssigneeId("[]");

// 2. âœ… åˆ›å»ºtask_userå…³è”è®°å½•
if (assigneeIds != null && !assigneeIds.isEmpty()) {
    List<TaskUser> taskUsers = assigneeIds.stream()
            .map(userId -> TaskUser.builder()
                    .taskId(saved.getId())
                    .projectId(projectId)  // å†—ä½™å­—æ®µ
                    .userId(userId)
                    .assignType(AssignType.ASSIGNED)
                    .assignedBy(creatorId)
                    .assignedAt(Instant.now())
                    .isActive(true)
                    .roleType(RoleType.EXECUTOR)
                    .build())
            .collect(Collectors.toList());
    
    taskUserRepository.saveAll(taskUsers);
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… è‡ªåŠ¨ç”ŸæˆTaskUserè®°å½•
- âœ… assignType=ASSIGNEDï¼ˆè¢«åˆ†é…ï¼‰
- âœ… assignedBy=creatorIdï¼ˆåˆ›å»ºäººï¼‰
- âœ… å†—ä½™project_idæå‡æŸ¥è¯¢æ€§èƒ½

---

### æ–¹æ³•2ï¼šassignTask() - é‡æ–°åˆ†é…ä»»åŠ¡

**ä¿®å¤å‰**ï¼š
```java
// åªæ›´æ–°JSONå­—æ®µ
task.setAssigneeId(convertListToJson(assigneeIds));
```

**ä¿®å¤å**ï¼š
```java
// 1. âœ… è½¯åˆ é™¤æ—§çš„task_userè®°å½•
Instant now = Instant.now();
taskUserRepository.deactivateTaskAssignees(taskId, now, operatorId);

// 2. âœ… æ·»åŠ æ–°çš„task_userè®°å½•
if (assigneeIds != null && !assigneeIds.isEmpty()) {
    List<TaskUser> newAssignees = new ArrayList<>();
    
    for (Long userId : assigneeIds) {
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è®°å½•ï¼ˆé¿å…å”¯ä¸€çº¦æŸå†²çªï¼‰
        Optional<TaskUser> existing = taskUserRepository.findByTaskIdAndUserId(taskId, userId);
        
        if (existing.isPresent()) {
            // å¦‚æœå­˜åœ¨ä½†è¢«åœç”¨ï¼Œåˆ™é‡æ–°æ¿€æ´»
            TaskUser taskUser = existing.get();
            if (!taskUser.getIsActive()) {
                taskUser.setIsActive(true);
                taskUser.setAssignedBy(operatorId);
                taskUser.setAssignedAt(now);
                taskUser.setAssignType(AssignType.ASSIGNED);
                taskUser.setRemovedAt(null);
                taskUser.setRemovedBy(null);
                newAssignees.add(taskUser);
            }
        } else {
            // ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°è®°å½•
            newAssignees.add(TaskUser.builder()
                    .taskId(taskId)
                    .projectId(task.getProjectId())
                    .userId(userId)
                    .assignType(AssignType.ASSIGNED)
                    .assignedBy(operatorId)
                    .assignedAt(now)
                    .isActive(true)
                    .roleType(RoleType.EXECUTOR)
                    .build());
        }
    }
    
    if (!newAssignees.isEmpty()) {
        taskUserRepository.saveAll(newAssignees);
    }
}

// 3. æ›´æ–°assigneeIdå­—æ®µä¸ºç©ºï¼ˆåºŸå¼ƒå­—æ®µï¼‰
task.setAssigneeId("[]");
```

**å…³é”®ç‚¹**ï¼š
- âœ… å…ˆè½¯åˆ é™¤æ—§çš„æ‰§è¡Œè€…ï¼ˆis_active=falseï¼‰
- âœ… å†æ·»åŠ æ–°çš„æ‰§è¡Œè€…
- âœ… ä¿ç•™å†å²è®°å½•ï¼ˆç”¨äºå®¡è®¡ï¼‰
- âœ… é¿å…å”¯ä¸€çº¦æŸå†²çª

---

### æ–¹æ³•3ï¼šclaimTask() - ç”¨æˆ·ä¸»åŠ¨æ¥å–ä»»åŠ¡

**ä¿®å¤å‰**ï¼š
```java
// åªæ›´æ–°JSONå­—æ®µ
List<Long> assigneeIds = new ArrayList<>(currentAssignees);
assigneeIds.add(userId);
task.setAssigneeId(convertListToJson(assigneeIds));
```

**ä¿®å¤å**ï¼š
```java
// 1. âœ… æ£€æŸ¥æ˜¯å¦å·²æ˜¯æ‰§è¡Œè€…ï¼ˆä½¿ç”¨task_userè¡¨ï¼‰
if (taskUserRepository.isUserActiveExecutor(taskId, userId)) {
    throw new IllegalArgumentException("æ‚¨å·²ç»æ˜¯è¯¥ä»»åŠ¡çš„æ‰§è¡Œè€…");
}

// 2. âœ… æ£€æŸ¥æ˜¯å¦å­˜åœ¨å†å²è®°å½•
Optional<TaskUser> existing = taskUserRepository.findByTaskIdAndUserId(taskId, userId);

Instant now = Instant.now();

if (existing.isPresent()) {
    // å¦‚æœå­˜åœ¨ä½†è¢«åœç”¨ï¼Œåˆ™é‡æ–°æ¿€æ´»
    TaskUser taskUser = existing.get();
    taskUser.setIsActive(true);
    taskUser.setAssignedBy(userId);  // è‡ªå·±åˆ†é…ç»™è‡ªå·±
    taskUser.setAssignedAt(now);
    taskUser.setAssignType(AssignType.CLAIMED);  // âœ… æ ‡è®°ä¸ºä¸»åŠ¨æ¥å–
    taskUser.setRemovedAt(null);
    taskUser.setRemovedBy(null);
    taskUserRepository.save(taskUser);
} else {
    // 3. âœ… åˆ›å»ºæ–°çš„task_userè®°å½•
    TaskUser taskUser = TaskUser.builder()
            .taskId(taskId)
            .projectId(task.getProjectId())
            .userId(userId)
            .assignType(AssignType.CLAIMED)  // âœ… ä¸»åŠ¨æ¥å–
            .assignedBy(userId)  // è‡ªå·±åˆ†é…ç»™è‡ªå·±
            .assignedAt(now)
            .isActive(true)
            .roleType(RoleType.EXECUTOR)
            .build();
    
    taskUserRepository.save(taskUser);
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… assignType=CLAIMEDï¼ˆä¸»åŠ¨æ¥å–ï¼‰
- âœ… assignedBy=userIdï¼ˆè‡ªå·±ï¼‰
- âœ… åŒºåˆ†äº†ASSIGNEDå’ŒCLAIMEDä¸¤ç§ç±»å‹

---

## ğŸ“Š ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | è¡Œæ•°å˜åŒ– |
|-----|---------|---------|
| `TaskServiceImpl.java` | æ·»åŠ ä¾èµ–ã€æ›´æ–°ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³• | +çº¦120è¡Œ |

---

## ğŸ§ª æµ‹è¯•éªŒè¯å»ºè®®

### 1. åˆ›å»ºä»»åŠ¡æµ‹è¯•

```bash
POST /api/tasks
{
    "projectId": 123,
    "title": "æµ‹è¯•ä»»åŠ¡",
    "assigneeIds": [1001, 1002]
}

# éªŒè¯ï¼šæŸ¥è¯¢task_userè¡¨
SELECT * FROM task_user WHERE task_id = ? AND is_active = TRUE;
# åº”è¯¥çœ‹åˆ°2æ¡è®°å½•ï¼Œassign_type = 'ASSIGNED'
```

### 2. åˆ†é…ä»»åŠ¡æµ‹è¯•

```bash
PUT /api/tasks/{taskId}/assign
{
    "assigneeIds": [1003, 1004]
}

# éªŒè¯1ï¼šæ—§æ‰§è¡Œè€…è¢«è½¯åˆ é™¤
SELECT * FROM task_user WHERE task_id = ? AND user_id IN (1001, 1002);
# is_activeåº”è¯¥ä¸ºFALSE

# éªŒè¯2ï¼šæ–°æ‰§è¡Œè€…è¢«æ·»åŠ 
SELECT * FROM task_user WHERE task_id = ? AND user_id IN (1003, 1004) AND is_active = TRUE;
# åº”è¯¥çœ‹åˆ°2æ¡æ–°è®°å½•
```

### 3. æ¥å–ä»»åŠ¡æµ‹è¯•

```bash
POST /api/tasks/{taskId}/claim

# éªŒè¯ï¼š
SELECT * FROM task_user WHERE task_id = ? AND user_id = ? AND is_active = TRUE;
# assign_typeåº”è¯¥ä¸º'CLAIMED'
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®è¿ç§»**ï¼šå¦‚æœæ•°æ®åº“ä¸­å·²æœ‰æ—§ä»»åŠ¡ï¼Œéœ€è¦å…ˆè¿è¡Œè¿ç§»è„šæœ¬ `V2.1__create_task_user_table.sql`
2. **äº‹åŠ¡ä¸€è‡´æ€§**ï¼šæ‰€æœ‰æ–¹æ³•éƒ½æ·»åŠ äº†`@Transactional`æ³¨è§£ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
3. **å”¯ä¸€çº¦æŸ**ï¼štask_userè¡¨æœ‰å”¯ä¸€çº¦æŸ`uk_task_user_role (task_id, user_id, role_type)`ï¼Œé¿å…é‡å¤åˆ†é…
4. **è½¯åˆ é™¤**ï¼šæ—§çš„æ‰§è¡Œè€…ä¸ä¼šè¢«ç‰©ç†åˆ é™¤ï¼Œè€Œæ˜¯æ ‡è®°ä¸º`is_active=FALSE`ï¼Œä¿ç•™å®¡è®¡è®°å½•
5. **åºŸå¼ƒå­—æ®µ**ï¼šTasksè¡¨çš„`assigneeId`å­—æ®µå·²åºŸå¼ƒï¼Œç»Ÿä¸€è®¾ä¸º`"[]"`ï¼Œæœªæ¥ç‰ˆæœ¬å¯åˆ é™¤

---

## ğŸ¯ é¢„æœŸæ•ˆæœ

ä¿®å¤åï¼š

âœ… **åˆ›å»ºä»»åŠ¡** â†’ è‡ªåŠ¨åœ¨task_userè¡¨åˆ›å»ºè®°å½•  
âœ… **åˆ†é…ä»»åŠ¡** â†’ è½¯åˆ é™¤æ—§è®°å½• + æ·»åŠ æ–°è®°å½•  
âœ… **æ¥å–ä»»åŠ¡** â†’ åˆ›å»ºCLAIMEDç±»å‹è®°å½•  
âœ… **æŸ¥è¯¢ä»»åŠ¡** â†’ ä»task_userè¡¨è¯»å–æ‰§è¡Œè€…åˆ—è¡¨  
âœ… **æŸ¥è¯¢ç”¨æˆ·ä»»åŠ¡** â†’ ç›´æ¥æŸ¥è¯¢task_userè¡¨  

---

## ğŸ“ åç»­å·¥ä½œ

1. ğŸ”„ æ›´æ–°`convertToDetailDTO()`æ–¹æ³•ï¼Œä»task_userè¡¨è¯»å–æ‰§è¡Œè€…
2. ğŸ”„ æ›´æ–°`getMyAssignedTasks()`æ–¹æ³•ï¼Œä½¿ç”¨task_userè¡¨æŸ¥è¯¢
3. ğŸ”„ æ›´æ–°å‰ç«¯æ¥å£ï¼Œå¤„ç†assignTypeå­—æ®µ
4. ğŸ§ª ç¼–å†™å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
5. ğŸ“š æ›´æ–°APIæ–‡æ¡£

---

## âœ… ä¿®å¤å®Œæˆæ—¶é—´

- **ä¿®å¤æ—¶é—´**: 2025-11-04
- **ä¿®å¤äºº**: AI Assistant
- **éªŒè¯çŠ¶æ€**: âœ… ä»£ç ç¼–è¯‘é€šè¿‡ï¼Œæ— è¯­æ³•é”™è¯¯

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [task_userè¡¨è®¾è®¡æ–‡æ¡£](../sql/zhiyan-mysql-service/task_user_relation.sql)
- [æ•°æ®è¿ç§»è„šæœ¬](../sql/zhiyan-mysql-service/MIGRON/V2.1__create_task_user_table.sql)
- [TaskUserå®ä½“ç±»](../zhiyan-modules/zhiyan-project/src/main/java/hbnu/project/zhiyanproject/model/entity/TaskUser.java)
- [TaskUserRepository](../zhiyan-modules/zhiyan-project/src/main/java/hbnu/project/zhiyanproject/repository/TaskUserRepository.java)

