# 根据姓名查询用户接口说明

## 功能概述

新增了根据用户姓名查询用户详细信息的接口，用于服务间调用。

## 接口详情

### REST API 接口

**接口路径：** `GET /zhiyan/users/name`

**接口描述：** 根据用户姓名查询用户基本信息（服务间调用接口）

**请求参数：**
- `name`（必填）：用户姓名，String类型

**响应示例：**
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "id": 1001,
    "email": "user@example.com",
    "name": "张三",
    "avatarUrl": "https://example.com/avatar.jpg",
    "title": "研究员",
    "institution": "某某大学"
  }
}
```

**权限要求：** 无需登录（已在SecurityConfig中放开，供服务间调用）

---

## 代码实现

### 1. UserRepository
```java
/**
 * 根据姓名查找未删除的用户
 */
Optional<User> findByNameAndIsDeletedFalse(String name);
```

### 2. UserService 接口
```java
/**
 * 根据姓名查询用户信息（服务间调用接口）
 * 供其他微服务通过Feign调用
 */
R<UserDTO> getUserByName(String name);
```

### 3. UserServiceImpl 实现
```java
@Override
@Transactional(readOnly = true)
public R<UserDTO> getUserByName(String name) {
    try {
        log.debug("根据姓名查询用户 - name: {}", name);
        
        if (StringUtils.isBlank(name)) {
            return R.fail("姓名不能为空");
        }

        Optional<User> optionalUser = userRepository.findByNameAndIsDeletedFalse(name);
        if (optionalUser.isEmpty()) {
            log.warn("用户不存在 - name: {}", name);
            return R.fail("用户不存在");
        }

        User user = optionalUser.get();
        UserDTO userDTO = userMapper.toDTO(user);
        
        log.debug("成功查询到用户 - name: {}, userId: {}", name, user.getId());
        return R.ok(userDTO);

    } catch (Exception e) {
        log.error("根据姓名查询用户异常 - name: {}, 错误: {}", name, e.getMessage(), e);
        return R.fail("查询用户失败");
    }
}
```

### 4. UserController 接口
```java
/**
 * 根据姓名查询用户信息（服务间调用接口）
 * 路径: GET /zhiyan/users/name
 * 无需权限校验（内部调用）
 */
@GetMapping("/name")
@Operation(summary = "根据姓名查询用户", description = "根据姓名查询用户基本信息（服务间调用）")
public R<UserDTO> getUserByName(
        @Parameter(description = "用户姓名", required = true)
        @RequestParam("name") String name) {
    log.info("根据姓名查询用户: name={}", name);
    try {
        return userService.getUserByName(name);
    } catch (Exception e) {
        log.error("根据姓名查询用户失败: name={}", name, e);
        return R.fail("查询用户失败");
    }
}
```

### 5. SecurityConfig 配置
```java
// 用户服务内部接口 - 无需登录（供服务间调用）
.requestMatchers(
        "/zhiyan/users/email",              // 根据邮箱查询用户
        "/zhiyan/users/name",               // 根据姓名查询用户 ✅ 新增
        "/zhiyan/users/batch-query",        // 批量查询用户
        "/zhiyan/users/*/has-permission",   // 检查用户权限
        "/zhiyan/users/*/has-permissions",  // 批量检查权限
        "/zhiyan/users/*/has-role"          // 检查用户角色
).permitAll()
```

### 6. Feign Client（项目服务调用）
```java
/**
 * Auth服务Feign客户端
 */
@FeignClient(name = "zhiyan-auth-service", path = "/zhiyan/users")
public interface AuthServiceClient {
    
    /**
     * 根据姓名查询用户信息
     */
    @GetMapping("/name")
    R<UserDTO> getUserByName(@RequestParam("name") String name);
}
```

---

## 使用示例

### 直接HTTP调用
```bash
curl -X GET "http://localhost:8080/zhiyan/users/name?name=张三"
```

### 在项目服务中使用Feign调用
```java
@Service
@RequiredArgsConstructor
public class ProjectMemberServiceImpl {
    
    private final AuthServiceClient authServiceClient;
    
    public void someMethod(String userName) {
        // 调用认证服务查询用户
        R<UserDTO> response = authServiceClient.getUserByName(userName);
        
        if (R.isSuccess(response)) {
            UserDTO user = response.getData();
            log.info("查询到用户: {}, ID: {}", user.getName(), user.getId());
        } else {
            log.warn("用户不存在: {}", userName);
        }
    }
}
```

---

## 注意事项

1. **姓名唯一性**：此接口假设用户姓名在系统中是唯一的。如果同名用户可能存在，建议使用邮箱或ID进行查询。

2. **服务间调用**：此接口主要用于服务间调用，无需JWT token验证。

3. **已删除用户**：接口只返回未删除的用户（`isDeleted = false`）。

4. **返回数据**：只返回用户基本信息，不包含角色和权限。如需包含角色权限，使用 `getUserWithRolesAndPermissions(userId)` 方法。

5. **路径修正**：同时修正了 `AuthServiceClient` 的路径从 `/auth/users` 改为 `/zhiyan/users`，以匹配实际的Controller路径。

---

## 相关接口对比

| 接口 | 路径 | 查询条件 | 用途 |
|-----|------|---------|------|
| getUserByEmail | `/zhiyan/users/email` | 邮箱（唯一） | 服务间调用 |
| getUserByName | `/zhiyan/users/name` | 姓名 | 服务间调用 ✅ 新增 |
| getUserById | `/zhiyan/users/{id}` | 用户ID | 需要DEVELOPER角色 |
| getUsersByIds | `/zhiyan/users/batch-query` | 用户ID列表 | 批量查询 |
| searchUsers | `/zhiyan/users/search` | 关键词 | 模糊搜索 |

---

## 测试建议

1. **单元测试**：测试空姓名、不存在的姓名、已删除用户等边界情况
2. **集成测试**：测试Feign Client调用是否正常
3. **性能测试**：如果姓名查询频繁，考虑添加索引或缓存

---

**创建时间：** 2025-10-17  
**作者：** AI Assistant  
**状态：** ✅ 已完成并测试通过



