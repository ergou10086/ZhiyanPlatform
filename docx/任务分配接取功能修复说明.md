# 任务分配与接取功能修复说明

## 🐛 问题分析

### 问题现象
用户创建任务后，无法看到：
1. **分配任务按钮**（用户+图标）
2. **接取任务按钮**

### 根本原因

#### 原因1：状态映射不匹配
- **后端**：创建任务时默认状态为 `TODO`（`TaskServiceImpl.java` 第86行）
- **前端**：只将 `PENDING` 映射为"待接取"，缺少 `TODO` 的映射
- **结果**：任务显示为 "TODO" 而不是 "待接取"

```java
// 后端 - TaskServiceImpl.java:86
.status(TaskStatus.TODO) // 新创建的任务默认为待办
```

```javascript
// 前端 - ProjectDetail.vue:2021（修复前）
const statusMap = {
  'PENDING': '待接取',  // ❌ 缺少 TODO 的映射
  'IN_PROGRESS': '进行中',
  // ...
}
```

#### 原因2：接取按钮显示条件
接取任务按钮只在状态为"待接取"时显示：

```vue
<!-- ProjectDetail.vue:215 -->
<div v-if="task.status === '待接取'" class="task-assign-section">
  <button @click="assignTask(task)" class="assign-btn">接取任务</button>
</div>
```

但由于状态显示为 "TODO"，条件不满足，按钮不显示。

## ✅ 解决方案

### 修复内容

已修改 `zhiyan_front/src/views/ProjectDetail.vue` 文件，添加状态映射：

#### 1. 添加 TODO 状态映射

```javascript
getStatusDisplay(status) {
  const statusMap = {
    'TODO': '待接取',      // ✅ 新增
    'PENDING': '待接取',
    'IN_PROGRESS': '进行中',
    'PAUSED': '暂停',
    'DONE': '完成',
    'BLOCKED': '阻塞',
    'CANCELLED': '已取消'
  }
  return statusMap[status] || status || '未知'
}
```

#### 2. 修改反向映射

```javascript
getStatusValue(status) {
  const reverseMap = {
    '待接取': 'TODO',      // ✅ 修改：映射到后端的TODO状态
    '进行中': 'IN_PROGRESS',
    '暂停': 'PAUSED',
    '完成': 'DONE',
    '阻塞': 'BLOCKED',
    '已取消': 'CANCELLED'
  }
  return reverseMap[status] || status || 'TODO'
}
```

## 🎯 如何验证修复

### 步骤1：重启前端服务
```bash
cd zhiyan_front
npm run serve
```

### 步骤2：刷新页面
按 `Ctrl + Shift + R` 强制刷新浏览器缓存

### 步骤3：查看任务状态
- 原来显示 "TODO" 的任务，现在应该显示**"待接取"**

### 步骤4：验证接取按钮
任务卡片下方应该出现**蓝色的"接取任务"按钮**：

```
┌─────────────────────────────────┐
│ 待接取   [▼] 👤+ ✏️ 🗑️        │  ← 项目管理员可见
│                                 │
│ 吉萨家                          │
│ 知嬴                            │
│ 2025-11-04                      │
│ 创建人: Tokito                  │
│                                 │
│ [ 接取任务 ]  ← 所有成员可见    │
└─────────────────────────────────┘
```

### 步骤5：验证分配按钮
**项目管理员**应该能看到任务卡片右上角的**分配任务按钮**（👤+图标）

## 📋 功能说明

### 1. 接取任务（所有成员）
**条件**：
- 任务状态为"待接取"（后端 `TODO` 状态）
- 是项目成员

**操作**：
1. 点击任务下方的"接取任务"按钮
2. 确认对话框点击"确定"
3. 任务负责人变为当前用户
4. 任务状态自动变为"进行中"

### 2. 分配任务（项目管理员）
**条件**：
- 当前用户是项目拥有者（负责人）

**操作**：
1. 点击任务卡片右上角的分配按钮（👤+图标）
2. 在弹出的模态框中选择团队成员
3. 点击"确认分配"
4. 任务负责人变为选中的成员
5. 任务状态自动变为"进行中"

## 🔍 排查指南

### 问题：仍然看不到接取按钮

**检查1**：任务状态是否为"待接取"
```javascript
// 浏览器控制台执行
console.log(document.querySelector('.task-status-btn').textContent)
// 应该显示：待接取
```

**检查2**：是否是项目成员
- 检查团队成员列表中是否有您的名字

### 问题：看不到分配按钮

**检查1**：是否是项目管理员
```javascript
// 浏览器控制台执行
const userInfo = JSON.parse(localStorage.getItem('user_info'))
console.log('当前用户:', userInfo.name)

// 查看项目负责人
console.log('项目负责人:', document.querySelector('[class*="meta-value"]').textContent)
```

**检查2**：用户名是否完全匹配
- 注意大小写
- 注意空格
- 两者必须完全一致

## 📊 状态流转

```
创建任务
   ↓
[TODO/待接取]  ← 新任务默认状态
   ↓
   ├─→ 成员接取任务
   │      ↓
   │   [IN_PROGRESS/进行中]
   │      ↓
   │   [DONE/完成]
   │
   └─→ 管理员分配任务
          ↓
       [IN_PROGRESS/进行中]
          ↓
       [DONE/完成]
```

## 🎨 后端状态枚举

```java
public enum TaskStatus {
    TODO("待办"),        // ✅ 前端显示：待接取
    IN_PROGRESS("进行中"),
    BLOCKED("阻塞"),
    DONE("已完成")
}
```

## 🚀 扩展建议

### 1. 添加 PENDING 状态支持
如果后端需要添加专门的 PENDING 状态：

```java
// TaskStatus.java
public enum TaskStatus {
    PENDING("待接取"),     // 新增
    TODO("待办"),
    IN_PROGRESS("进行中"),
    BLOCKED("阻塞"),
    DONE("已完成")
}
```

### 2. 优化创建任务逻辑
可以根据是否分配执行者来决定初始状态：

```java
// TaskServiceImpl.java
TaskStatus initialStatus = (assigneeIds == null || assigneeIds.isEmpty()) 
    ? TaskStatus.TODO      // 无执行者：待接取
    : TaskStatus.IN_PROGRESS;  // 有执行者：进行中
```

## ✨ 总结

**已修复的问题**：
- ✅ TODO 状态现在正确显示为"待接取"
- ✅ 接取任务按钮现在可以正常显示
- ✅ 状态流转逻辑正确

**用户操作**：
1. 重启前端服务
2. 刷新浏览器
3. 检查任务状态是否显示"待接取"
4. 检查是否出现"接取任务"按钮

**如有问题**：
请提供浏览器控制台的错误信息和截图

