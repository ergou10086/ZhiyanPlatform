# 操作日志模块修复说明

## 问题描述

activelog 操作日志模块无法收集和持久化业务模块的操作日志，导致数据库中没有日志记录。

## 根本原因分析

### 1. 数据库表混乱问题
由于 JPA 的 `ddl-auto: update` 策略 + 实体扫描配置不当，导致：
- 操作日志表（`project_operation_log`, `wiki_operation_log` 等）被创建到各个业务数据库中
- 不同模块的表混在一起，数据库结构混乱

### 2. 事务管理器未正确指定
`OperationLogplusService` 的 `@Transactional` 注解没有指定事务管理器，导致：
- 使用了默认的主数据源事务管理器
- 操作日志无法正确保存到 `zhiyan_activelog_db` 数据库

### 3. 多数据源配置缺失
各业务服务没有为 activelog 模块配置独立的数据源，导致：
- activelog 的 Repository 和 Entity 无法正确注册
- AOP 切面虽然能拦截到操作，但无法持久化日志

## 解决方案

### 1. 配置多数据源

为每个业务服务添加 `ActivelogDataSourceConfig.java`，配置 activelog 专用数据源：

```java
@Configuration
@EnableTransactionManagement
@EnableJpaRepositories(
        basePackages = "hbnu.project.zhiyanactivelog.repository",
        entityManagerFactoryRef = "activelogEntityManagerFactory",
        transactionManagerRef = "activelogTransactionManager"
)
public class ActivelogDataSourceConfig {
    // 配置 activelog 数据源、EntityManagerFactory 和 TransactionManager
}
```

### 2. 修改配置文件

在各服务的 `application-dev.yml` 中添加 activelog 数据源配置：

```yaml
spring:
  datasource:
    # 主数据源（业务数据库）
    url: jdbc:mysql://localhost:3306/zhiyan_xxx_db?...
    username: root
    password: zjm10086
    
    # Activelog 数据源（操作日志独立数据库）
    activelog:
      url: jdbc:mysql://localhost:3306/zhiyan_activelog_db?...
      username: root
      password: zjm10086
      driver-class-name: com.mysql.cj.jdbc.Driver
```

### 3. 修正事务管理器

在 `OperationLogplusService` 中指定正确的事务管理器：

```java
@Transactional(transactionManager = "activelogTransactionManager")
protected <T> void saveLogSync(...) {
    // 保存日志
}

@Async
@Transactional(transactionManager = "activelogTransactionManager")
protected <T> void saveLogAsync(...) {
    // 异步保存日志
}
```

### 4. 清理混乱的数据库表

执行 `sql/cleanup-mixed-tables.sql` 脚本，删除错误创建在业务数据库中的操作日志表。

## 工作原理

### 数据流向

1. **业务请求** → Controller 方法（带 `@BizOperationLog` 注解）
2. **AOP 拦截** → `OperationLogAspect` 切面拦截方法调用
3. **异步处理** → 使用 `operationLogTaskExecutor` 线程池异步记录日志
4. **日志保存** → `OperationLogSaveService` → `OperationLogplusService`
5. **数据持久化** → 使用 `activelogTransactionManager` 保存到 `zhiyan_activelog_db`

### 多数据源隔离

```
┌─────────────────────────────────────────┐
│  Business Service (如 zhiyan-project)   │
├─────────────────────────────────────────┤
│                                         │
│  ┌───────────────┐  ┌───────────────┐  │
│  │  主数据源      │  │ Activelog数据源│  │
│  ├───────────────┤  ├───────────────┤  │
│  │ EntityManager │  │ EntityManager │  │
│  │ (default)     │  │ (activelog)   │  │
│  ├───────────────┤  ├───────────────┤  │
│  │ Transaction   │  │ Transaction   │  │
│  │ Manager       │  │ Manager       │  │
│  │ (default)     │  │ (activelog)   │  │
│  └───────┬───────┘  └───────┬───────┘  │
│          │                  │          │
│          ▼                  ▼          │
│  ┌───────────────┐  ┌───────────────┐  │
│  │ 业务Repository │  │ 日志Repository │  │
│  └───────┬───────┘  └───────┬───────┘  │
└──────────┼──────────────────┼──────────┘
           │                  │
           ▼                  ▼
   ┌───────────────┐  ┌───────────────┐
   │ 业务数据库     │  │ 日志数据库     │
   │ zhiyan_xxx_db │  │ zhiyan_       │
   │               │  │ activelog_db  │
   └───────────────┘  └───────────────┘
```

## 涉及的服务

已修复的服务：
- ✅ zhiyan-project（项目管理模块）
- ✅ zhiyan-knowledge（知识库模块）
- ✅ zhiyan-wiki（Wiki模块）
- ✅ zhiyan-auth（认证模块）

## 验证步骤

1. **启动服务**
   ```bash
   # 启动各个微服务
   ```

2. **执行业务操作**
   - 创建项目
   - 创建任务
   - 上传成果
   - 编辑Wiki

3. **检查日志表**
   ```sql
   USE zhiyan_activelog_db;
   SELECT * FROM project_operation_log ORDER BY operation_time DESC LIMIT 10;
   SELECT * FROM task_operation_log ORDER BY operation_time DESC LIMIT 10;
   SELECT * FROM wiki_operation_log ORDER BY operation_time DESC LIMIT 10;
   SELECT * FROM achievement_operation_log ORDER BY operation_time DESC LIMIT 10;
   ```

4. **查看应用日志**
   ```
   grep "保存.*操作日志成功" logs/zhiyan-*-service.log
   ```

## 注意事项

1. **保持 JPA update 策略**
   - 各业务数据库：`hibernate.hbm2ddl.auto: update`
   - Activelog 数据库：`hibernate.hbm2ddl.auto: update`
   - 这样可以自动创建和更新表结构

2. **数据库隔离**
   - 操作日志表只会在 `zhiyan_activelog_db` 中创建
   - 业务表只会在各自的业务数据库中创建
   - 不会再出现表混乱的情况

3. **异步处理**
   - 日志记录使用独立线程池，不影响业务性能
   - 即使日志保存失败，也不会影响业务操作

4. **事务隔离**
   - 业务事务和日志事务完全隔离
   - 业务回滚不会影响日志记录
   - 日志失败不会导致业务回滚

## 后续优化建议

1. **性能优化**
   - 考虑使用消息队列（如 RocketMQ）异步处理日志
   - 批量写入日志，减少数据库压力

2. **日志查询优化**
   - 添加更多索引，提升查询性能
   - 考虑使用 Elasticsearch 存储历史日志

3. **日志归档**
   - 定期归档历史日志到冷存储
   - 保留近期日志在热数据库中

4. **监控告警**
   - 监控日志写入失败率
   - 监控日志数据库连接池状态
   - 日志堆积告警

## 修复时间

2025-11-20

## 修复人员

ErgouTree & AI Assistant

