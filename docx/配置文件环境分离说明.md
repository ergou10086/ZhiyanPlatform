# 配置文件环境分离说明

## 概述

本项目所有模块已完成配置文件的环境分离，支持开发环境（dev）和生产环境（prod）的独立配置。

## 已完成环境分离的模块

1. **zhiyan-auth** - 认证授权模块
2. **zhiyan-common-basic** - 公共基础模块
3. **zhiyan-common-redis** - Redis公共模块
4. **zhiyan-gateway** - 网关模块

## 配置文件结构

每个模块的配置文件遵循以下结构：

```
src/main/resources/
├── application.yml           # 主配置文件（通用配置，指定默认环境）
├── application-dev.yml       # 开发环境配置
├── application-prod.yml      # 生产环境配置
├── bootstrap.yml            # 启动核心配置（通用配置，指定默认环境）
├── bootstrap-dev.yml        # 开发环境启动配置
└── bootstrap-prod.yml       # 生产环境启动配置
```

## 配置文件说明

### 1. application.yml
- **作用**：主配置文件，包含通用配置
- **内容**：
  - 默认环境配置（prod）
  - 应用基本信息
  - 通用日志格式

### 2. bootstrap.yml
- **作用**：启动核心配置文件，优先于 application.yml 加载
- **内容**：
  - 应用名称
  - 默认环境配置（prod）

### 3. application-dev.yml
- **作用**：开发环境的具体配置
- **特点**：
  - Nacos地址：127.0.0.1:8848（本地）
  - 日志级别：DEBUG（详细调试信息）
  - 监控端点：暴露所有端点（`include: '*'`）
  - 健康检查：显示所有详细信息（`show-details: always`）

### 4. application-prod.yml
- **作用**：生产环境的具体配置
- **特点**：
  - Nacos地址：10.7.10.98:8848（服务器）
  - 日志级别：INFO（生产级别）
  - 监控端点：仅暴露必要端点（`include: health,info,metrics`）
  - 健康检查：根据授权显示详细信息（`show-details: when-authorized`）
  - 数据库密码：使用环境变量

### 5. bootstrap-dev.yml
- **作用**：开发环境的启动核心配置
- **特点**：
  - Nacos地址：127.0.0.1:8848
  - 启动日志级别：DEBUG

### 6. bootstrap-prod.yml
- **作用**：生产环境的启动核心配置
- **特点**：
  - Nacos地址：10.7.10.98:8848
  - 启动日志级别：INFO

## 环境切换方式

### 方式1：通过环境变量（推荐）

```bash
# 启动开发环境
export SPRING_PROFILES_ACTIVE=dev
java -jar application.jar

# 启动生产环境
export SPRING_PROFILES_ACTIVE=prod
java -jar application.jar
```

### 方式2：通过命令行参数

```bash
# 启动开发环境
java -jar application.jar --spring.profiles.active=dev

# 启动生产环境
java -jar application.jar --spring.profiles.active=prod
```

### 方式3：在IDEA中配置

1. 打开 Run/Debug Configurations
2. 在 Environment variables 中添加：`SPRING_PROFILES_ACTIVE=dev`
3. 或在 VM options 中添加：`-Dspring.profiles.active=dev`

## 各模块特定配置说明

### zhiyan-auth（认证模块）
- **开发环境**：
  - 端口：8091
  - 数据库：localhost:3306
  - 密码：zjm10086
- **生产环境**：
  - 端口：8091
  - 数据库：localhost:3306
  - 密码：root

### zhiyan-common-basic（公共基础模块）
- **开发环境**：
  - Nacos配置中心：127.0.0.1:8848
  - 禁用服务发现
- **生产环境**：
  - Nacos配置中心：10.7.10.98:8848
  - 禁用服务发现

### zhiyan-common-redis（Redis公共模块）
- **开发环境**：
  - 端口：8099
  - Redis地址：127.0.0.1:6379
  - Redis密码：zjm10086
  - 连接池最大连接数：8
- **生产环境**：
  - 端口：8099
  - Redis地址：10.7.10.98:6379
  - Redis密码：通过环境变量 ${REDIS_PASSWORD:}
  - 连接池最大连接数：16

### zhiyan-gateway（网关模块）
- **开发环境**：
  - 端口：9005
  - Nacos地址：127.0.0.1:8848
  - Gateway日志：DEBUG
- **生产环境**：
  - 端口：9005
  - Nacos地址：10.7.10.98:8848
  - Gateway日志：INFO

## 默认环境

所有模块的默认环境都设置为 **prod**（生产环境）。这意味着：
- 如果不指定任何环境变量，应用将以生产环境配置启动
- 开发时需要明确指定 `dev` 环境

## 最佳实践

1. **本地开发**：始终使用 `dev` 环境
   ```bash
   export SPRING_PROFILES_ACTIVE=dev
   ```

2. **服务器部署**：使用 `prod` 环境（默认）
   ```bash
   java -jar application.jar
   # 或明确指定
   java -jar application.jar --spring.profiles.active=prod
   ```

3. **敏感信息**：
   - 生产环境的敏感信息（如数据库密码、Redis密码）应通过环境变量传递
   - 不要在配置文件中硬编码生产环境的敏感信息

4. **日志配置**：
   - 开发环境使用 DEBUG 级别，方便调试
   - 生产环境使用 INFO 级别，减少日志量

5. **监控端点**：
   - 开发环境暴露所有监控端点，方便开发调试
   - 生产环境仅暴露必要的监控端点，提高安全性

## 注意事项

1. **Nacos命名空间**：所有环境使用相同的命名空间（`3936229d-c8b3-4947-9192-6b984dca44bf`）

2. **配置优先级**：
   - bootstrap 配置优先于 application 配置
   - 环境特定配置（如 application-dev.yml）优先于通用配置（application.yml）
   - 命令行参数 > 环境变量 > 配置文件

3. **配置文件格式**：
   - 统一使用 `.yml` 格式（YAML）
   - 注意：zhiyan-common-basic 的 bootstrap 文件是 `.yaml`，其他都是 `.yml`

4. **热更新**：
   - Nacos配置支持动态刷新（`refresh=true`）
   - 修改Nacos中的配置后，应用可以自动更新（需要配置 `@RefreshScope`）

## 故障排查

### 问题1：应用使用了错误的环境配置

**原因**：未正确设置环境变量

**解决方案**：
```bash
# 检查当前环境
echo $SPRING_PROFILES_ACTIVE

# 设置正确的环境
export SPRING_PROFILES_ACTIVE=dev
```

### 问题2：无法连接到Nacos

**原因**：Nacos地址配置错误或Nacos服务未启动

**解决方案**：
1. 检查对应环境的配置文件中的 Nacos 地址
2. 确认 Nacos 服务已启动
3. 检查网络连接和防火墙设置

### 问题3：配置未生效

**原因**：配置文件优先级问题

**解决方案**：
1. 确认环境变量设置正确
2. 检查配置文件的加载顺序
3. 查看启动日志中的 `[BOOTSTRAP]` 标记，确认加载了哪些配置文件

## 维护建议

1. **新增环境**：如需新增测试环境（test），创建对应的配置文件：
   - application-test.yml
   - bootstrap-test.yml

2. **配置同步**：修改通用配置时，确保在 application.yml 和 bootstrap.yml 中同步更新

3. **文档更新**：新增或修改配置时，及时更新本文档

4. **版本控制**：
   - 配置文件应纳入版本控制
   - 敏感信息使用环境变量或配置中心管理，不要提交到代码仓库

## 环境对比表

| 配置项 | 开发环境(dev) | 生产环境(prod) |
|-------|--------------|---------------|
| Nacos地址 | 127.0.0.1:8848 | 10.7.10.98:8848 |
| 日志级别 | DEBUG | INFO |
| 监控端点 | 全部暴露 | 仅必要端点 |
| 健康检查 | 显示所有详情 | 授权后显示 |
| Redis连接池 | max: 8 | max: 16 |
| 数据库密码 | 明文配置 | 环境变量 |

---

**最后更新时间**：2025-10-16

