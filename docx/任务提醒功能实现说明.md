# 任务提醒功能实现说明

## 功能概述

在前端首页添加"快要截止的任务"提醒模块，自动显示用户在所有参与项目中即将到期的任务（未来7天内），帮助用户及时关注重要工作。

## 后端实现

### 1. 数据库层（TaskRepository.java）

添加了两个新的查询方法：

#### 1.1 查询即将到期的任务
```java
@Query(value = "SELECT * FROM tasks WHERE JSON_CONTAINS(assignee_id, :userId, '$') " +
               "AND due_date <= :dueDate AND due_date >= CURDATE() " +
               "AND status != 'DONE' AND is_deleted = false " +
               "ORDER BY due_date ASC", 
       nativeQuery = true)
Page<Tasks> findMyUpcomingTasks(@Param("userId") String userId,
                                 @Param("dueDate") LocalDate dueDate,
                                 Pageable pageable);
```

**查询逻辑：**
- 使用 `JSON_CONTAINS` 查询负责人字段（支持多个负责人）
- 截止日期在当前日期和目标日期之间
- 排除已完成的任务（`status != 'DONE'`）
- 排除已删除的任务（`is_deleted = false`）
- 按截止日期升序排序（最紧急的在前面）

#### 1.2 查询已逾期的任务
```java
@Query(value = "SELECT * FROM tasks WHERE JSON_CONTAINS(assignee_id, :userId, '$') " +
               "AND due_date < :currentDate " +
               "AND status != 'DONE' AND is_deleted = false " +
               "ORDER BY due_date DESC", 
       nativeQuery = true)
Page<Tasks> findMyOverdueTasks(@Param("userId") String userId,
                                @Param("currentDate") LocalDate currentDate,
                                Pageable pageable);
```

### 2. 服务层（TaskService & TaskServiceImpl）

添加了两个服务方法：

#### 2.1 获取用户即将到期的任务
```java
Page<TaskDetailDTO> getMyUpcomingTasks(Long userId, int days, Pageable pageable);
```

**参数说明：**
- `userId`: 当前用户ID
- `days`: 未来天数（默认7天）
- `pageable`: 分页参数

**返回值：** 包含任务详情的分页对象

#### 2.2 获取用户已逾期的任务
```java
Page<TaskDetailDTO> getMyOverdueTasks(Long userId, Pageable pageable);
```

**特性：**
- 自动批量查询用户信息，避免N+1问题
- 返回完整的任务详情，包括项目名称、负责人信息、优先级等
- 自动计算是否逾期

### 3. 控制器层（TaskController）

添加了两个REST API接口：

#### 3.1 获取我的即将到期任务

**接口地址：** `GET /zhiyan/api/projects/tasks/my-upcoming`

**请求参数：**
```json
{
  "days": 7,      // 可选，默认7天
  "page": 0,      // 可选，默认第0页
  "size": 10      // 可选，默认10条
}
```

**响应示例：**
```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "content": [
      {
        "id": "123456789",
        "projectId": "987654321",
        "projectName": "量子计算算法优化研究",
        "title": "完成算法模型设计",
        "description": "设计并实现新的量子算法模型",
        "status": "IN_PROGRESS",
        "statusName": "进行中",
        "priority": "HIGH",
        "priorityName": "高优先级",
        "dueDate": "2025-11-04",
        "isOverdue": false,
        "assignees": [
          {
            "userId": "100001",
            "userName": "张三",
            "email": "zhangsan@example.com",
            "avatarUrl": "https://..."
          }
        ],
        "createdBy": "100002",
        "creatorName": "李四",
        "createdAt": "2025-10-20T10:30:00",
        "updatedAt": "2025-10-28T15:20:00"
      }
    ],
    "totalElements": 5,
    "totalPages": 1,
    "size": 10,
    "number": 0
  }
}
```

#### 3.2 获取我的已逾期任务

**接口地址：** `GET /zhiyan/api/projects/tasks/my-overdue`

**请求参数：**
```json
{
  "page": 0,      // 可选，默认第0页
  "size": 10      // 可选，默认10条
}
```

**响应格式：** 同上

---

## 前端实现

### 1. API层（task.js）

添加了两个API调用方法：

```javascript
// 获取我的即将到期的任务
taskAPI.getMyUpcomingTasks(days = 7, page = 0, size = 10)

// 获取我的已逾期任务
taskAPI.getMyOverdueTasks(page = 0, size = 10)
```

### 2. 页面层（Home.vue）

#### 2.1 数据状态
```javascript
data() {
  return {
    upcomingTasks: [],           // 即将到期的任务列表
    upcomingTasksCount: 0,       // 任务总数
    tasksLoading: false,         // 加载状态
    tasksError: null             // 错误信息
  }
}
```

#### 2.2 核心方法

**加载任务：**
```javascript
async loadUpcomingTasks() {
  // 检查登录状态
  // 调用API获取任务
  // 更新数据状态
}
```

**格式化日期：**
```javascript
formatDate(dateString) {
  // 返回人性化的日期显示
  // 例如："今天"、"明天"、"3 天后"、"已逾期 2 天"
}
```

**获取优先级样式：**
```javascript
getPriorityClass(priority) {
  // 返回对应的CSS类名
  // HIGH -> 'high-priority' (红色)
  // MEDIUM -> 'medium-priority' (黄色)
  // LOW -> 'low-priority' (绿色)
}
```

**点击任务跳转：**
```javascript
goToTaskDetail(task) {
  // 跳转到项目详情页，并传递任务ID
  this.$router.push({
    path: `/project/${task.projectId}`,
    query: { taskId: task.id }
  })
}
```

#### 2.3 UI特性

1. **加载状态** - 显示旋转加载动画
2. **空状态** - 没有任务时显示友好提示
3. **任务数量徽章** - 醒目显示任务数量
4. **优先级标识** - 不同颜色边框和背景
5. **逾期标记** - 红色高亮显示已逾期的截止日期
6. **项目名称标签** - 显示任务所属项目
7. **悬停效果** - 鼠标悬停时有动画效果
8. **点击交互** - 点击任务跳转到项目详情

---

## 使用说明

### 前端调用示例

```javascript
import { taskAPI } from '@/api/task'

// 获取7天内即将到期的任务（前5个）
const response = await taskAPI.getMyUpcomingTasks(7, 0, 5)

if (response.code === 200) {
  const tasks = response.data.content
  const totalCount = response.data.totalElements
  
  // 处理任务数据
  tasks.forEach(task => {
    console.log(`任务: ${task.title}`)
    console.log(`项目: ${task.projectName}`)
    console.log(`截止日期: ${task.dueDate}`)
    console.log(`优先级: ${task.priorityName}`)
  })
}
```

### 页面访问

1. 用户登录后访问首页
2. 系统自动加载并显示即将到期的任务
3. 显示未来7天内需要完成的任务
4. 按截止日期升序排列（最紧急的在最前面）
5. 点击任务卡片可以跳转到项目详情页

---

## 技术亮点

1. **性能优化** - 使用批量查询避免N+1问题
2. **用户体验** - 人性化的日期显示和空状态提示
3. **视觉设计** - 优先级颜色编码，一目了然
4. **响应式** - 自适应不同屏幕尺寸
5. **错误处理** - 优雅处理网络错误和未登录状态
6. **可扩展性** - 易于添加更多筛选条件和排序方式

---

## 未来扩展建议

1. **通知功能** - 任务临近时发送邮件或站内通知
2. **更多筛选** - 按项目、按优先级筛选
3. **任务统计** - 显示任务完成率、逾期率等
4. **快捷操作** - 直接在首页更新任务状态
5. **智能排序** - 根据优先级和截止日期智能排序
6. **移动端优化** - 适配移动设备显示

---

## 注意事项

1. 需要用户登录才能查看任务
2. 只显示用户作为负责人的任务
3. 已完成和已删除的任务不会显示
4. 默认显示7天内的任务，可调整时间范围
5. 使用分页加载，避免一次性加载过多数据

---

## 测试建议

1. **正常场景** - 有即将到期任务时的显示
2. **空状态** - 没有任务时的提示
3. **逾期任务** - 已逾期任务的高亮显示
4. **多优先级** - 不同优先级任务的样式
5. **未登录** - 未登录时不显示错误
6. **网络错误** - 网络异常时的错误处理
7. **点击交互** - 任务跳转功能
8. **响应式** - 不同屏幕尺寸的显示

---

**实现时间：** 2025-10-28  
**作者：** AI Assistant  
**版本：** v1.0

